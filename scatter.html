<!DOCTYPE html>
<html lang="en">
<head>
	<title>Herramientas de Visualizacion - Ma. Isabel Gonzalez</title>
	<meta charset="utf-8">
	<!-- Establecer el ancho de pantalla en base al dispositivo -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Cargar las librerias css -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/estilos.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/d3.v5.js"></script>

</head>
<body>

<nav class="navbar navbar-dark bg-dark">
	<a class="navbar-brand" href="#"><span class="d-none d-sm-none d-md-block"><img id="logo" alt="Logo" src="imagenes/logo.png"></span><span class="d-inline-block">Herramientas de Visualizaci&oacute;n</span></a>
</nav>

<div class="container-fluid">
	<div class="row">
		<div class="col-sm-12 col-12" >&nbsp;</div>
	</div>


	<div class="form-group row">
		<div class="col-lg-1"></div>

		<div class="col-md-3 col-sm-12 col-12">
			<div class="row" id="divAnio">
				<div class="col-sm-12 col-12">
					<span class="d-block p-2 bg-dark text-white">A&ntilde;o</span>
				</div>
				<div class="col-sm-12 col-12">
					<select id="selectAnio">
						<option value=""></option>
						<option value="2009">2009</option>
						<option value="2010">2010</option>
						<option value="2011">2011</option>
						<option value="2012">2012</option>
						<option value="2013">2013</option>
						<option value="2014">2014</option>
						<option value="2015">2015</option>
						<option value="2016">2016</option>
						<option value="2017">2017</option>
						<option value="2018">2018</option>
						<option value="2019">2019</option>
						<option value="2020">2020</option>
					</select>
				</div>
			</div>
			<div class="row" id="divEstado">
				<div class="col-sm-12 col-12">
					<span class="d-block p-2 bg-dark text-white">Cluster</span>
				</div>
				<div class="col-sm-12 col-12">
					<select id="selectCluster">
						<option value=""></option>
						<option value="0">0</option>
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
						<option value="9">9</option>
						<option value="10">10</option>
						<option value="11">11</option>
						<option value="12">12</option>
						<option value="13">13</option>
						<option value="14">14</option>
						<option value="15">15</option>
						<option value="16">16</option>
						<option value="17">17</option>
						<option value="18">18</option>
						<option value="19">19</option>
						<option value="20">20</option>
						<option value="21">21</option>
						<option value="22">22</option>
						<option value="23">23</option>
						<option value="24">24</option>
						<option value="25">25</option>
						<option value="26">26</option>
						<option value="27">27</option>
						<option value="28">28</option>
						<option value="29">29</option>
					</select>
				</div>
			</div>
		</div>

		<div class="col-lg-7 col-md-9 col-sm-12 col-12">
			<div class="row">
				<div class="col-sm-11 col-11" id="divGraficaD3scatter">&nbsp;</div>
			</div>
		</div>

		<div class="col-lg-1"></div>
	</div>


	<div class="row">
		<div class="col-sm-12 col-12">&nbsp;</div>
	</div>

	<div class="row">
		<div class="col-sm-12 col-12"><button type="button" class="btn btn-sm btn-outline-secondary"><a href="index.html" style="color:inherit">Regresar</a></button></div>
	</div>

	<div class="row">
		<div class="col-sm-12 col-12">&nbsp;</div>
	</div>
</div>


<script type = "text/javascript">

// Definir variables globales
var info = [];

// Asignar elementos a las variables
var divGrafica = d3.select("#divGraficaD3scatter");

var d3_category437 = [
'0xd3fe14', '0xfec7f8', '0x0b7b3e', '0x0bf0e9', '0xc203c8', '0xfd9b39', '0x888593',
'0x906407', '0x98ba7f', '0xfe6794', '0x10b0ff', '0xac7bff', '0xfee7c0', '0x964c63',
'0x1da49c', '0x0ad811', '0xbbd9fd', '0xfe6cfe', '0x297192', '0xd1a09c', '0x78579e',
'0x81ffad', '0x739400', '0xca6949', '0xd9bf01', '0x646a58', '0xd5097e', '0xbb73a9',
'0xccf6e9', '0x9cb4b6', '0xb6a7d4', '0x9e8c62', '0x6e83c8', '0x01af64', '0xa71afd',
'0xcfe589', '0xd4ccd1', '0xfd4109', '0xbf8f0e', '0x2f786e', '0x4ed1a5', '0xd8bb7d',
'0xa54509', '0x6a9276', '0xa4777a', '0xfc12c9', '0x606f15', '0x3cc4d9', '0xf31c4e',
'0x73616f', '0xf097c6', '0xfc8772', '0x92a6fe', '0x875b44', '0x699ab3', '0x94bc19',
'0x7d5bf0', '0xd24dfe', '0xc85b74', '0x68ff57', '0xb62347', '0x994b91', '0x646b8c',
'0x977ab4', '0xd694fd', '0xc4d5b5', '0xfdc4bd', '0x1cae05', '0x7bd972', '0xe9700a',
'0xd08f5d', '0x8bb9e1', '0xfde945', '0xa29d98', '0x1682fb', '0x9ad9e0', '0xd6cafe',
'0x8d8328', '0xb091a7', '0x647579', '0x1f8d11', '0xe7eafd', '0xb9660b', '0xa4a644',
'0xfec24c', '0xb1168c', '0x188cc1', '0x7ab297', '0x4468ae', '0xc949a6', '0xd48295',
'0xeb6dc2', '0xd5b0cb', '0xff9ffb', '0xfdb082', '0xaf4d44', '0xa759c4', '0xa9e03a',
'0x0d906b', '0x9ee3bd', '0x5b8846', '0x0d8995', '0xf25c58', '0x70ae4f', '0x847f74',
'0x9094bb', '0xffe2f1', '0xa67149', '0x936c8e', '0xd04907', '0xc3b8a6', '0xcef8c4',
'0x7a9293', '0xfda2ab', '0x2ef6c5', '0x807242', '0xcb94cc', '0xb6bdd0', '0xb5c75d',
'0xfde189', '0xb7ff80', '0xfa2d8e', '0x839a5f', '0x28c2b5', '0xe5e9e1', '0xbc79d8',
'0x7ed8fe', '0x9f20c3', '0x4f7a5b', '0xf511fd', '0x09c959', '0xbcd0ce', '0x8685fd',
'0x98fcff', '0xafbff9', '0x6d69b4', '0x5f99fd', '0xaaa87e', '0xb59dfb', '0x5d809d',
'0xd9a742', '0xac5c86', '0x9468d5', '0xa4a2b2', '0xb1376e', '0xd43f3d', '0x05a9d1',
'0xc38375', '0x24b58e', '0x6eabaf', '0x66bf7f', '0x92cbbb', '0xddb1ee', '0x1be895',
'0xc7ecf9', '0xa6baa6', '0x8045cd', '0x5f70f1', '0xa9d796', '0xce62cb', '0x0e954d',
'0xa97d2f', '0xfcb8d3', '0x9bfee3', '0x4e8d84', '0xfc6d3f', '0x7b9fd4', '0x8c6165',
'0x72805e', '0xd53762', '0xf00a1b', '0xde5c97', '0x8ea28b', '0xfccd95', '0xba9c57',
'0xb79a82', '0x7c5a82', '0x7d7ca4', '0x958ad6', '0xcd8126', '0xbdb0b7', '0x10e0f8',
'0xdccc69', '0xd6de0f', '0x616d3d', '0x985a25', '0x30c7fd', '0x0aeb65', '0xe3cdb4',
'0xbd1bee', '0xad665d', '0xd77070', '0x8ea5b8', '0x5b5ad0', '0x76655e', '0x598100',
'0x86757e', '0x5ea068', '0xa590b8', '0xc1a707', '0x85c0cd', '0xe2cde9', '0xdcd79c',
'0xd8a882', '0xb256f9', '0xb13323', '0x519b3b', '0xdd80de', '0xf1884b', '0x74b2fe',
'0xa0acd2', '0xd199b0', '0xf68392', '0x8ccaa0', '0x64d6cb', '0xe0f86a', '0x42707a',
'0x75671b', '0x796e87', '0x6d8075', '0x9b8a8d', '0xf04c71', '0x61bd29', '0xbcc18f',
'0xfecd0f', '0x1e7ac9', '0x927261', '0xdc27cf', '0x979605', '0xec9c88',
'0x8c48a3','0x676769', '0x546e64', '0x8f63a2', '0xb35b2d', '0x7b8ca2', '0xb87188',
'0x4a9bda', '0xeb7dab', '0xf6a602', '0xcab3fe', '0xddb8bb', '0x107959', '0x885973',
'0x5e858e', '0xb15bad', '0xe107a7', '0x2f9dad', '0x4b9e83', '0xb992dc', '0x6bb0cb',
'0xbdb363', '0xccd6e4', '0xa3ee94', '0x9ef718', '0xfbe1d9', '0xa428a5', '0x93514c',
'0x487434', '0xe8f1b6', '0xd00938', '0xfb50e1', '0xfa85e1', '0x7cd40a', '0xf1ade1',
'0xb1485d', '0x7f76d6', '0xd186b3', '0x90c25e', '0xb8c813', '0xa8c9de', '0x7d30fe',
'0x815f2d', '0x737f3b', '0xc84486', '0x946cfe', '0xe55432', '0xa88674', '0xc17a47',
'0xb98b91', '0xfc4bb3', '0xda7f5f', '0xdf920b', '0xb7bbba', '0x99e6d9', '0xa36170',
'0xc742d8', '0x947f9d', '0xa37d93', '0x889072', '0x9b924c', '0x23b4bc', '0xe6a25f',
'0x86df9c', '0xa7da6c', '0x3fee03', '0xeec9d8', '0xaafdcb', '0x7b9139', '0x92979c',
'0x72788a', '0x994cff', '0xc85956', '0x7baa1a', '0xde72fe', '0xc7bad8', '0x85ebfe',
'0x6e6089', '0x9b4d31', '0x297a1d', '0x9052c0', '0x5c75a5', '0x698eba', '0xd46222',
'0x6da095', '0xb483bb', '0x04d183', '0x9bcdfe', '0x2ffe8c', '0x9d4279', '0xc909aa',
'0x826cae', '0x77787c', '0xa96fb7', '0x858f87', '0xfd3b40', '0x7fab7b', '0x9e9edd',
'0xbba3be', '0xf8b96c', '0x7be553', '0xc0e1ce', '0x516e88', '0xbe0e5f', '0x757c09',
'0x4b8d5f', '0x38b448', '0xdf8780', '0xebb3a0', '0xced759', '0xf0ed7c', '0xe0eef1',
'0x0969d2', '0x756446', '0x488ea8', '0x888450', '0x61979c', '0xa37ad6', '0xb48a54',
'0x8193e5', '0xdd6d89', '0x8aa29d', '0xc679fe', '0xa4ac12', '0x75bbb3', '0x6ae2c1',
'0xc4fda7', '0x606877', '0xb2409d', '0x5874c7', '0xbf492c', '0x4b88cd', '0xe14ec0',
'0xb39da2', '0xfb8300', '0xd1b845', '0xc2d083', '0xc3caef', '0x967500', '0xc56399',
'0xed5a05', '0xaadff6', '0x6685f4', '0x1da16f', '0xf28bff', '0xc9c9bf', '0xc7e2a9',
'0x5bfce4', '0xe0e0bf', '0xe8e2e8', '0xddf2d8', '0x9108f8', '0x932dd2', '0xc03500',
'0xaa3fbc', '0x547c79', '0x9f6045', '0x04897b', '0x966f32', '0xd83212', '0x039f27',
'0xdf4280', '0xef206e', '0x0095f7', '0xa5890d', '0x9a8f7f', '0xbc839e', '0x88a23b',
'0xe55aed', '0x51af9e',
'0x5eaf82', '0x9e91fa', '0xf76c79', '0x99a869', '0xd2957d', '0xa2aca6', '0xe3959e',
'0xadaefc', '0x5bd14e', '0xdf9ceb', '0xfe8fb1', '0x87ca80', '0xfc986d', '0x2ad3d9',
'0xe8a8bb', '0xa7c79c', '0xa5c7cc', '0x7befb7', '0xb7e2e0', '0x85f57b', '0xf5d95b',
'0xdbdbff', '0xfddcff', '0x6e56bb', '0x226fa8', '0x5b659c', '0x58a10f', '0xe46c52',
'0x62abe2', '0xc4aa77', '0xb60e74', '0x087983', '0xa95703', '0x2a6efb', '0x427d92'
];

console.log(d3_category437);

var tooltip = divGrafica.append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "1px")
    .style("border-radius", "5px")
    .style("padding", "10px")


function mouseover(d) {
    tooltip
      .style("opacity", 1)
}

function mousemove(d) {
    tooltip
      .html(d[3]+" : "+d[2])
      .style("left", (d3.mouse(this)[0]+90) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
}


function mouseleave(d) {
    tooltip
      .transition()
      .duration(200)
      .style("opacity", 0)
}


// Funcion para generar la grafica
function grafica()
{
	// Definir variables locales
	let clientesTotal = [];
	let clientesFiltrado = [];
	let resumen = [];
	let maximo = 0;

    clientesFiltrado = info;

    // Genera sumatorias con los datos filtrados
	clientesTotal = d3.nest()
		.key(function(d){ return d.CLUSTER; })
		.key(function(d){ return d.INGRESOSMENDES; })
		.key(function(d){ return d.ESTADODES; })
		.key(function(d){ return d.ANIO_ALTA_CTE; })
		.key(function(d){ return d.GENERACION_CTE; })
		.rollup(function(v) { return d3.sum(v, function(d) { return d.TOTAL; }); })
		.entries(clientesFiltrado);

	clientesTotal.forEach(function(d) {
		let opc = '';

		d.values.forEach(function(d1) {
			d1.values.forEach(function(d2) {
				d2.values.forEach(function(d3) {
					d3.values.forEach(function(d4) {
						opc = d1.key+' - '+d2.key+' - '+d3.key+' - '+d4.key;
						resumen.push ([d.key, d1.key, d4.value, opc ]);
					});
				});
			});
		});

	});
	//console.log(resumen);

	let margin = {
		top: 20,
		right: 20,
		bottom: 90,
		left: 50};

	// Calcula las dimensiones para el componente svg
	let width = divGrafica.style('width').slice(0, -2)
	let height = parseInt(width * 9 / 16)

	// Estableclemos los rangos
	let x = d3.scaleBand()
		.rangeRound([0, width])
		.padding(0.1);
	let y = d3.scaleLinear()
		.rangeRound([height, 0]);

	// Agrega el svg al DOM
	var svg = divGrafica.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	x.domain(resumen.map(function (d) {
		return d[1];
	}));

	y.domain([0, d3.max(resumen, function(d) { return d[2]; })]);

	// Agregamos los puntos
	svg.selectAll("dot")
		.data(resumen)
		.enter().append("circle")
			.attr("r", 5)
			.attr("cx", function(d) { return x(d[1]); })
			.attr("cy", function(d) { return y(d[2]); })
			.attr("fill", function(d) { return (d3_category437[d[0]]); })
		.on("mouseover", mouseover )
		.on("mousemove", mousemove )
		.on("mouseleave", mouseleave );

	// Agregamos el eje X
	svg.append("g")
	    .attr("transform", "translate(0," + height + ")")
	    .call(d3.axisBottom(x))
	      	.selectAll("text")
			.attr("transform", "translate(-10,10)rotate(-45)")
			.style("text-anchor", "end")
			.style("font-size", 10)
			.style("fill", "#00000");

	// Agregamos el eje Y
	svg.append("g")
		.call(d3.axisLeft(y));
}


// Cargar el archivo con los datos
d3.csv("data/clientes_con_cluster.csv").then(function(data) {
	data.forEach(d => {
		d.SDO_CAPTACION = +d.SDO_CAPTACION
		d.SDO_CORTE = +d.SDO_CORTE
		d.MONTO_NOMINA = +d.MONTO_NOMINA
		d.TOTAL = +d.TOTAL
	});

	//Guarda la informacion obtenida en la variable global
	info = data;

	// Crea el array para años de originacion
	let arrayAnio = d3.set(info.map(d => d.ANIO_ALTA_CTE))
		.values()
		.sort()
	console.log(arrayAnio)


	// Crea el array para cluster
	let arrayCluster = d3.set(info.map(d => d.CLUSTER))
		.values()
		.sort()
	console.log(arrayCluster)


	// Crea el array para ingresos
	let arrayIngresos = d3.set(info.map(d => d.INGRESOSMENDES))
		.values()
		.sort()

	grafica();
})


</script>

</body>
</html>
