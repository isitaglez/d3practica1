<!DOCTYPE html>
<html lang="en">
<head>
	<title>Herramientas de Visualizacion - Ma. Isabel Gonzalez</title>
	<meta charset="utf-8">
	<!-- Establecer el ancho de pantalla en base al dispositivo -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Cargar las librerias css -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/estilos.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/d3.v5.js"></script>

</head>
<body>

<nav class="navbar navbar-dark bg-dark">
	<a class="navbar-brand" href="#"><span class="d-none d-sm-none d-md-block"><img id="logo" alt="Logo" src="imagenes/logo.png"></span><span class="d-inline-block">Herramientas de Visualizaci&oacute;n</span></a>
</nav>

<div class="container-fluid">
	<div class="row">
		<div class="col-sm-12 col-12" >&nbsp;</div>
	</div>


	<div class="form-group row">
		<div class="col-lg-1"></div>

		<div class="col-md-3 col-sm-12 col-12">
			<div class="row" id="divAnio">
				<div class="col-sm-12 col-12">
					<span class="d-block p-2 bg-dark text-white">A&ntilde;o</span>
				</div>
				<div class="col-sm-12 col-12">
					<select id="selectAnio" autocomplete="off" class="form-control custom-select" onChange="grafica();">
						<option value=""></option>
						<option value="2009">2009</option>
						<option value="2010">2010</option>
						<option value="2011">2011</option>
						<option value="2012">2012</option>
						<option value="2013">2013</option>
						<option value="2014">2014</option>
						<option value="2015">2015</option>
						<option value="2016">2016</option>
						<option value="2017">2017</option>
						<option value="2018">2018</option>
						<option value="2019">2019</option>
						<option value="2020">2020</option>
					</select>
				</div>
			</div>
			<div class="row" id="divEstado">
				<div class="col-sm-12 col-12">
					<span class="d-block p-2 bg-dark text-white">Cluster</span>
				</div>
				<div class="col-sm-12 col-12">
					<select id="selectCluster" autocomplete="off" class="form-control custom-select" onChange="grafica();">
						<option value=""></option>
						<option value="0">0</option>
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
						<option value="6">6</option>
						<option value="7">7</option>
						<option value="8">8</option>
						<option value="9">9</option>
						<option value="10">10</option>
						<option value="11">11</option>
						<option value="12">12</option>
						<option value="13">13</option>
						<option value="14">14</option>
						<option value="15">15</option>
						<option value="16">16</option>
						<option value="17">17</option>
						<option value="18">18</option>
						<option value="19">19</option>
						<option value="20">20</option>
						<option value="21">21</option>
						<option value="22">22</option>
						<option value="23">23</option>
						<option value="24">24</option>
						<option value="25">25</option>
						<option value="26">26</option>
						<option value="27">27</option>
						<option value="28">28</option>
						<option value="29">29</option>
					</select>
				</div>
			</div>
		</div>

		<div class="col-lg-7 col-md-9 col-sm-12 col-12">
			<div class="row">
				<div class="col-sm-11 col-11" id="divGraficaD3scatter">&nbsp;</div>
			</div>
		</div>

		<div class="col-lg-1"></div>
	</div>


	<div class="row">
		<div class="col-sm-12 col-12">&nbsp;</div>
	</div>

	<div class="row">
		<div class="col-sm-12 col-12"><a href="index.html" style="color:inherit"><button type="button" class="btn btn-sm btn-outline-secondary">Regresar</button></a></div>
	</div>

	<div class="row">
		<div class="col-sm-12 col-12">&nbsp;</div>
	</div>
</div>


<script type = "text/javascript">

// Definir variables globales
var info = [];

// Asignar elementos a las variables
var divGrafica = d3.select("#divGraficaD3scatter");

var d3_category437 = [
'#d3fe14', '#fec7f8', '#0b7b3e', '#0bf0e9', '#c203c8', '#fd9b39', '#888593',
'#906407', '#98ba7f', '#fe6794', '#10b0ff', '#ac7bff', '#fee7c0', '#964c63',
'#1da49c', '#0ad811', '#bbd9fd', '#fe6cfe', '#297192', '#d1a09c', '#78579e',
'#81ffad', '#739400', '#ca6949', '#d9bf01', '#646a58', '#d5097e', '#bb73a9',
'#ccf6e9', '#9cb4b6', '#b6a7d4', '#9e8c62', '#6e83c8', '#01af64', '#a71afd',
'#cfe589', '#d4ccd1', '#fd4109', '#bf8f0e', '#2f786e', '#4ed1a5', '#d8bb7d',
'#a54509', '#6a9276', '#a4777a', '#fc12c9', '#606f15', '#3cc4d9', '#f31c4e',
'#73616f', '#f097c6', '#fc8772', '#92a6fe', '#875b44', '#699ab3', '#94bc19',
'#7d5bf0', '#d24dfe', '#c85b74', '#68ff57', '#b62347', '#994b91', '#646b8c',
'#977ab4', '#d694fd', '#c4d5b5', '#fdc4bd', '#1cae05', '#7bd972', '#e9700a',
'#d08f5d', '#8bb9e1', '#fde945', '#a29d98', '#1682fb', '#9ad9e0', '#d6cafe',
'#8d8328', '#b091a7', '#647579', '#1f8d11', '#e7eafd', '#b9660b', '#a4a644',
'#fec24c', '#b1168c', '#188cc1', '#7ab297', '#4468ae', '#c949a6', '#d48295',
'#eb6dc2', '#d5b0cb', '#ff9ffb', '#fdb082', '#af4d44', '#a759c4', '#a9e03a',
'#0d906b', '#9ee3bd', '#5b8846', '#0d8995', '#f25c58', '#70ae4f', '#847f74',
'#9094bb', '#ffe2f1', '#a67149', '#936c8e', '#d04907', '#c3b8a6', '#cef8c4',
'#7a9293', '#fda2ab', '#2ef6c5', '#807242', '#cb94cc', '#b6bdd0', '#b5c75d',
'#fde189', '#b7ff80', '#fa2d8e', '#839a5f', '#28c2b5', '#e5e9e1', '#bc79d8',
'#7ed8fe', '#9f20c3', '#4f7a5b', '#f511fd', '#09c959', '#bcd0ce', '#8685fd',
'#98fcff', '#afbff9', '#6d69b4', '#5f99fd', '#aaa87e', '#b59dfb', '#5d809d',
'#d9a742', '#ac5c86', '#9468d5', '#a4a2b2', '#b1376e', '#d43f3d', '#05a9d1',
'#c38375', '#24b58e', '#6eabaf', '#66bf7f', '#92cbbb', '#ddb1ee', '#1be895',
'#c7ecf9', '#a6baa6', '#8045cd', '#5f70f1', '#a9d796', '#ce62cb', '#0e954d',
'#a97d2f', '#fcb8d3', '#9bfee3', '#4e8d84', '#fc6d3f', '#7b9fd4', '#8c6165',
'#72805e', '#d53762', '#f00a1b', '#de5c97', '#8ea28b', '#fccd95', '#ba9c57',
'#b79a82', '#7c5a82', '#7d7ca4', '#958ad6', '#cd8126', '#bdb0b7', '#10e0f8',
'#dccc69', '#d6de0f', '#616d3d', '#985a25', '#30c7fd', '#0aeb65', '#e3cdb4',
'#bd1bee', '#ad665d', '#d77070', '#8ea5b8', '#5b5ad0', '#76655e', '#598100',
'#86757e', '#5ea068', '#a590b8', '#c1a707', '#85c0cd', '#e2cde9', '#dcd79c',
'#d8a882', '#b256f9', '#b13323', '#519b3b', '#dd80de', '#f1884b', '#74b2fe',
'#a0acd2', '#d199b0', '#f68392', '#8ccaa0', '#64d6cb', '#e0f86a', '#42707a',
'#75671b', '#796e87', '#6d8075', '#9b8a8d', '#f04c71', '#61bd29', '#bcc18f',
'#fecd0f', '#1e7ac9', '#927261', '#dc27cf', '#979605', '#ec9c88',
'#8c48a3','#676769', '#546e64', '#8f63a2', '#b35b2d', '#7b8ca2', '#b87188',
'#4a9bda', '#eb7dab', '#f6a602', '#cab3fe', '#ddb8bb', '#107959', '#885973',
'#5e858e', '#b15bad', '#e107a7', '#2f9dad', '#4b9e83', '#b992dc', '#6bb0cb',
'#bdb363', '#ccd6e4', '#a3ee94', '#9ef718', '#fbe1d9', '#a428a5', '#93514c',
'#487434', '#e8f1b6', '#d00938', '#fb50e1', '#fa85e1', '#7cd40a', '#f1ade1',
'#b1485d', '#7f76d6', '#d186b3', '#90c25e', '#b8c813', '#a8c9de', '#7d30fe',
'#815f2d', '#737f3b', '#c84486', '#946cfe', '#e55432', '#a88674', '#c17a47',
'#b98b91', '#fc4bb3', '#da7f5f', '#df920b', '#b7bbba', '#99e6d9', '#a36170',
'#c742d8', '#947f9d', '#a37d93', '#889072', '#9b924c', '#23b4bc', '#e6a25f',
'#86df9c', '#a7da6c', '#3fee03', '#eec9d8', '#aafdcb', '#7b9139', '#92979c',
'#72788a', '#994cff', '#c85956', '#7baa1a', '#de72fe', '#c7bad8', '#85ebfe',
'#6e6089', '#9b4d31', '#297a1d', '#9052c0', '#5c75a5', '#698eba', '#d46222',
'#6da095', '#b483bb', '#04d183', '#9bcdfe', '#2ffe8c', '#9d4279', '#c909aa',
'#826cae', '#77787c', '#a96fb7', '#858f87', '#fd3b40', '#7fab7b', '#9e9edd',
'#bba3be', '#f8b96c', '#7be553', '#c0e1ce', '#516e88', '#be0e5f', '#757c09',
'#4b8d5f', '#38b448', '#df8780', '#ebb3a0', '#ced759', '#f0ed7c', '#e0eef1',
'#0969d2', '#756446', '#488ea8', '#888450', '#61979c', '#a37ad6', '#b48a54',
'#8193e5', '#dd6d89', '#8aa29d', '#c679fe', '#a4ac12', '#75bbb3', '#6ae2c1',
'#c4fda7', '#606877', '#b2409d', '#5874c7', '#bf492c', '#4b88cd', '#e14ec0',
'#b39da2', '#fb8300', '#d1b845', '#c2d083', '#c3caef', '#967500', '#c56399',
'#ed5a05', '#aadff6', '#6685f4', '#1da16f', '#f28bff', '#c9c9bf', '#c7e2a9',
'#5bfce4', '#e0e0bf', '#e8e2e8', '#ddf2d8', '#9108f8', '#932dd2', '#c03500',
'#aa3fbc', '#547c79', '#9f6045', '#04897b', '#966f32', '#d83212', '#039f27',
'#df4280', '#ef206e', '#0095f7', '#a5890d', '#9a8f7f', '#bc839e', '#88a23b',
'#e55aed', '#51af9e',
'#5eaf82', '#9e91fa', '#f76c79', '#99a869', '#d2957d', '#a2aca6', '#e3959e',
'#adaefc', '#5bd14e', '#df9ceb', '#fe8fb1', '#87ca80', '#fc986d', '#2ad3d9',
'#e8a8bb', '#a7c79c', '#a5c7cc', '#7befb7', '#b7e2e0', '#85f57b', '#f5d95b',
'#dbdbff', '#fddcff', '#6e56bb', '#226fa8', '#5b659c', '#58a10f', '#e46c52',
'#62abe2', '#c4aa77', '#b60e74', '#087983', '#a95703', '#2a6efb', '#427d92'
];

//console.log(d3_category437);

var tooltip = divGrafica.append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "1px")
    .style("border-radius", "5px")
    .style("padding", "10px")


function mouseover(d) {
    tooltip
      .style("opacity", 1)
}

function mousemove(d) {
    tooltip
      .html('Cluster '+d[0]+' - '+d[3]+" : "+d[2])
      .style("left", (d3.mouse(this)[0]+90) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
}

function mouseleave(d) {
    tooltip
      .transition()
      .duration(200)
      .style("opacity", 0)
}


// Funcion para generar la grafica
function grafica()
{
	// Definir variables locales
	let clientesTotal = [];
	let clientesFiltrado = [];
	let resumen = [];
	let maximo = 0;

    clientesFiltrado = info;

    divGrafica.selectAll('svg').remove();


    // Si esta seleccionado algun año aplicar el filtro
    if ( $("#selectAnio").val()!= "") {
    	clientesFiltrado = info.filter(function(d){ return d.ANIO_ALTA_CTE==$("#selectAnio").val() })
    }


    if ( $("#selectCluster").val()!= "") {
    	clientesFiltrado = clientesFiltrado.filter(function(d){ return d.CLUSTER==$("#selectCluster").val() })
    }


    // Genera sumatorias con los datos filtrados
	clientesTotal = d3.nest()
		.key(function(d){ return d.CLUSTER; })
		.key(function(d){ return d.INGRESOSMENDES; })
		.key(function(d){ return d.ESTADODES; })
		.key(function(d){ return d.ANIO_ALTA_CTE; })
		.key(function(d){ return d.GENERACION_CTE; })
		.rollup(function(v) { return d3.sum(v, function(d) { return d.TOTAL; }); })
		.entries(clientesFiltrado);

	clientesTotal.forEach(function(d) {
		let opc = '';

		d.values.forEach(function(d1) {
			d1.values.forEach(function(d2) {
				d2.values.forEach(function(d3) {
					d3.values.forEach(function(d4) {
						opc = d1.key+' - '+d2.key+' - '+d3.key+' - '+d4.key;
						resumen.push ([d.key, d1.key, d4.value, opc ]);
					});
				});
			});
		});

	});
	//console.log(resumen);

	let margin = {
		top: 20,
		right: 20,
		bottom: 90,
		left: 50
	};

	// Calcula las dimensiones para el componente svg
	let width = divGrafica.style('width').slice(0, -2)
	let height = parseInt(width * 9 / 16)

	// Estableclemos los rangos
	let x = d3.scaleBand()
		.rangeRound([0, width])
		.padding(0.1);
	let y = d3.scaleLinear()
		.rangeRound([height, 0]);

	// Agrega el svg al DOM
	var svg = divGrafica.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	x.domain(resumen.map(function (d) {
		return d[1];
	}));

	y.domain([0, d3.max(resumen, function(d) { return d[2]; })]);

	// Agregamos los puntos
	svg.selectAll("dot")
		.data(resumen)
		.enter().append("circle")
			.attr("r", 5)
			.attr("cx", function(d) { return x(d[1]); })
			.attr("cy", function(d) { return y(d[2]); })
			.attr("fill", function(d) { return d3_category437[d[0]]; })
		.on("mouseover", mouseover)
		.on("mousemove", mousemove)
		.on("mouseleave", mouseleave);

	// Agregamos el eje X
	svg.append("g")
	    .attr("transform", "translate(0," + height + ")")
	    .call(d3.axisBottom(x))
	      	.selectAll("text")
			.attr("transform", "translate(-10,10)rotate(-45)")
			.style("text-anchor", "end")
			.style("font-size", 10)
			.style("fill", "#00000");

	// Agregamos el eje Y
	svg.append("g")
		.call(d3.axisLeft(y));
}


// Cargar el archivo con los datos
d3.csv("data/clientes_con_cluster.csv").then(function(data) {
	data.forEach(d => {
		d.SDO_CAPTACION = +d.SDO_CAPTACION
		d.SDO_CORTE = +d.SDO_CORTE
		d.MONTO_NOMINA = +d.MONTO_NOMINA
		d.TOTAL = +d.TOTAL
	});

	//Guarda la informacion obtenida en la variable global
	info = data;

	// Crea el array para años de originacion
	let arrayAnio = d3.set(info.map(d => d.ANIO_ALTA_CTE))
		.values()
		.sort()
	//console.log(arrayAnio)


	// Crea el array para cluster
	let arrayCluster = d3.set(info.map(d => d.CLUSTER))
		.values()
		.sort()
	//console.log(arrayCluster)

	// Crea el array para ingresos
	let arrayIngresos = d3.set(info.map(d => d.INGRESOSMENDES))
		.values()
		.sort()

	grafica();
})


</script>

</body>
</html>
